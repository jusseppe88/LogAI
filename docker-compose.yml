services:
  # 1. Your Custom Python API (Log Fetcher)
  logai-api:
    build: ./api
    container_name: LogAI
    restart: unless-stopped
    ports:
      - "8765:8765"
      - "2526:2526" # SMTP Proxy Port
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=Europe/London
      - MAILCOW_IP=192.168.1.100 # REPLACE THIS WITH YOUR MAIL SERVER IP
      - MAILCOW_PORT=465         # REPLACE THIS WITH YOUR MAIL SERVER PORT
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Needs access to Docker
      - /var/log:/host_logs:ro                    # Needs access to System Logs
      - /etc/machine-id:/etc/machine-id:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s  

  # 2. n8n (The Workflow Orchestrator)
  n8n:
    image: docker.n8n.io/n8nio/n8n
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=${SUBDOMAIN}.${DOMAIN_NAME}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://n8n:5678/
      # IMPORTANT: Allow n8n to talk to local storage if needed
    volumes:
      - n8n_data:/home/node/.n8n

  # 3. Ollama (The AI / LLM)
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_storage:/root/.ollama

  # 4. Qdrant (Vector Database for Memory)
  qdrant:
    image: qdrant/qdrant
    container_name: qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
    volumes:
      - qdrant_storage:/qdrant/storage

# Define persistent storage for all databases
volumes:
  n8n_data:
  ollama_storage:
  qdrant_storage:
